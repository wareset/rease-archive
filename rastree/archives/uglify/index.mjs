import e from'@wareset-utilites/lang/jsonStringify';import t from'@wareset-utilites/lang/jsonParse';import r from'@wareset-utilites/array/findIndexLeft';import o from'@wareset-utilites/array/forEachRight';import i from'@wareset-utilites/array/forEachLeft';import s from'@wareset-utilites/array/includes';import a from'@wareset-utilites/is/isArray';import l from'@wareset-utilites/object/keys';import p from'@wareset-utilites/array/last';import m from'rastree/core/utils/getDelimeter';import{getTokens as n}from'rastree/core/template/lib/utils';import f from'rastree/core/utils/replaceQuotes';import u from'rastree/core/template/lib/trimTokens';import c,{TOKEN_IDENTIFIER as y,TOKEN_STRING as v,TOKEN_PUCNTUATOR as h,TOKEN_TEMPLATE as g,TOKEN_SPACE as b,TOKEN_KEYWORD as j}from'rastree/core/template/lib/source2Tokens';import d from'rastree/core/template/lib/stringifyTokens';import*as w from'@rease/optimize/data';import*as k from'./function';import*as x from'./functionprototype';import*as z from'./json';import*as $ from'./math';import*as S from'./number';import*as T from'./lang';import*as D from'./object';import*as E from'./objectprototype';const L={};i(l(w),(e=>{L[w[e]]=e}));const M=l(L).sort(((e,t)=>t.length-e.length)),N=(e,t=h)=>({type:t,value:e}),O=()=>[N(') '),N(' ',b),N('+'),N(' ',b)],A=()=>[N(' ',b),N('+'),N(' ',b),N('(')],F=e=>(a(e)?i(e,F):(delete e.loc,delete e.deep,delete e.range),e),I=(e,t)=>{let o=r(e,(e=>') '===e.value),t+1);e[o].value=')';const i=e.slice(t+1,o),s=i.length;let a;u(i),((a=!i[1])||i.length!==s)&&(i[0]||(o+=3),a&&(t--,o++),e.splice(t+1,o-t-1,...i))},J=(e,t,r)=>e+t+r;export default(a,{safeMath:u=!0,safeDefaults:w=!0,uglifyStrings:P=!0}={})=>{const Q=m(a,'$'),R=(t=>{const o=n(t);let i,s,a,l=o.length;for(;l-- >0;)(i=o[l])&&(F(i),a=i.value,i.type===g?(i.type=v,'`'===a[0]&&p(a)===a[0]?i.value=f(a):'}'===a[0]&&'{'===p(a)?(o.splice(l,1,...O(),N(f('`'+a.slice(1,-2)+'`'),v),...A()),I(o,l+8)):'`'===p(a)?(i.value=f('`'+a.slice(1)),o.splice(l,0,...O())):'`'===a[0]&&(i.value=f(a.slice(0,-2)+'`'),o.splice(l+1,0,...A()),I(o,l+4))):i.type===v?i.value=f(a):'.'===i.value&&i.type===h&&s&&s.type!==h&&o.splice(l,r(o,(e=>e===s),l+1)-l+1,N('['),N(e(s.value),v),N(']')),!(i=o[l])||'['!==i.value&&']'!==i.value||('['===i.value&&(i=o[l+1])&&i.type===b&&o.splice(l+1,1),(i=o[l-1])&&i.type===b&&(!(i=o[l-2])||i.type===h&&')'!==i.value||o.splice(l++-1,1))),o[l].type!==b&&(s=o[l]));return o})(c(a).tokens),q={};let B=[];const C={};u&&(C.Math=['math',l($)]),w&&(C.JSON=['json',l(z)],C.Number=['number',l(S)],C.Object=['object',l(D).filter((e=>!(e in E)))],C[J('object','prototype',Q)]=['objectprototype',l(E)],C.Function=['function',l(k)],C[J('function','prototype',Q)]=['functionprototype',l(x)],B=l(T));const G=l(C),H={},K={};let U,V,W;i(R,((i,a,l,p)=>{let{type:m,value:n}=i;if(m===j&&('import'===n&&(U=!0),'export'===n&&(V=!0)),V&&(!W&&m===v||W&&m===h)&&(V=!1),!U&&!V)if(m===y){let e,r;s(G,n)&&(e=R[a+1])&&'['===e.value&&(e=R[a+3])&&']'===e.value&&(e=R[a+2])&&e.type===v&&s(C[n][1],r=t(e.value))?(i.value=J(C[n][0],r,Q),H[i.value]=[C[n][0],r],R.splice(a+1,3),p.index--):s(B,n)&&(K[n]=1)}else if(m===v&&P){let l;if(n=t(n),n in L)i.type=y,i.value=L[n]+Q,q[L[n]]=1;else if((l=r(M,(e=>s(n,e))))>-1){const t=M[l];q[L[t]]=1;const r=[];r.unshift(N(')'));const i=L[t]+Q;o(n.split(t),((t,o)=>{t&&(r[1]&&r.unshift(N('+')),r.unshift(N(e(t),v))),o&&(r[1]&&r.unshift(N('+')),r.unshift(N(i,y)))})),r.unshift(N('(')),R.splice(a,1,...r),p.index--}}(U||V)&&('from'===n&&(W=!0),(m===v||m===h&&/[^,{}]/.test(n))&&(U=V=W=!1))}));const X=l(q);let Y='';X[0]&&(Y='import { '+X.map((e=>e+' as '+e+Q)).join(', ')+' } from \'@rease/optimize/data\';\n\n');const Z=l(K);let _='';Z[0]&&(_='import { '+Z.join(', ')+' } from \'@rease/optimize/lang\';\n\n');let ee=l(H).map((e=>`import { ${H[e][1]} as ${e} } from '@rease/optimize/${H[e][0]}';\n`)).join('');ee&&(ee+='\n');return _+ee+Y+d(R)};
